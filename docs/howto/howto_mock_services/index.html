<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Mock services · ZIO</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="## How to test interactions between services?"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Mock services · ZIO"/><meta property="og:type" content="website"/><meta property="og:url" content="https://zio.dev/"/><meta property="og:description" content="## How to test interactions between services?"/><meta name="twitter:card" content="summary"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100,"cornerOffset":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/"><img class="logo" src="/img/navbar_brand.png" alt="ZIO"/><h2 class="headerTitleWithLogo">ZIO</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/docs/overview/overview_index" target="_self">Overview</a></li><li class=""><a href="/docs/datatypes/datatypes_index" target="_self">Data Types</a></li><li class=""><a href="/docs/interop/interop_index" target="_self">Interop</a></li><li class=""><a href="/docs/usecases/usecases_index" target="_self">Use Cases</a></li><li class="siteNavGroupActive"><a href="/docs/howto/howto_index" target="_self">How to</a></li><li class=""><a href="/docs/resources/resources" target="_self">Resources</a></li><li class=""><a href="/docs/ecosystem/ecosystem" target="_self">Ecosystem</a></li><li class=""><a href="/docs/about/about_index" target="_self">About</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>How to</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle">How to</h3><ul class=""><li class="navListItem"><a class="navItem" href="/docs/howto/howto_index">Summary</a></li><li class="navListItem"><a class="navItem" href="/docs/howto/howto_use_module_pattern">Use module pattern</a></li><li class="navListItem"><a class="navItem" href="/docs/howto/howto_test_effects">Test effects</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/howto/howto_mock_services">Mock services</a></li><li class="navListItem"><a class="navItem" href="/docs/howto/howto_handle_errors">Handle errors</a></li><li class="navListItem"><a class="navItem" href="/docs/howto/howto_access_system_information">Access system information</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 class="postHeaderTitle">Mock services</h1></header><article><div><span><h2><a class="anchor" aria-hidden="true" id="how-to-test-interactions-between-services"></a><a href="#how-to-test-interactions-between-services" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>How to test interactions between services?</h2>
<p>Whenever possible, we should strive to make our functions pure, which makes testing such function easy - you just need to assert on the return value.
However in larger applications there is a need for intermediate layers that delegate the work to specialized services.</p>
<p>For example, in a HTTP server the first layer of indirection are so called <em>routes</em>, whose job is to match the request and delegate the processing to
downstream layers. Often below there is a second layer of indirection, so called <em>controllers</em>, which consist of several business logic units grouped
by their domain. In a RESTful API that would be all operations on a certain model. The <em>controller</em> to perform its job might call on futher
specialized services for communicating with the database, sending emails, logging, et cetera.</p>
<p>If the job of the <em>capability</em> is to call on another <em>capability</em>, how should we test it?</p>
<h2><a class="anchor" aria-hidden="true" id="hidden-outputs"></a><a href="#hidden-outputs" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hidden outputs</h2>
<p>A pure function is such a function which operates only on its inputs and produces only its output. Command-like methods, by definition are inpure, as
their job is to change state of the collaborating object (performing a <em>side effect</em>). For example:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> scala.concurrent.<span class="hljs-type">Future</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">Event</span>): <span class="hljs-type">Future</span>[<span class="hljs-type">Unit</span>] = <span class="hljs-type">Future</span>(println(<span class="hljs-string">s"Got <span class="hljs-subst">$event</span>"</span>))
</code></pre>
<p>The signature of this method <code>Event =&gt; Future[Unit]</code> hints us we're dealing with a command. It returns <code>Unit</code> (well, wrapped in future, but it does
not matter here), you can't do anything useful with <code>Unit</code> and it does not contain any information. It is the equivalent of returning nothing. It is
also an unreliable return type, as when Scala expects the return type to be <code>Unit</code> it will discard whatever value it had (for details see
<a href="https://scala-lang.org/files/archive/spec/2.13/06-expressions.html#value-conversions">Section 6.26.1</a> of the Scala Language Specification), which may shadow the fact that the final value produced (and discarded) was
not the one you expected.</p>
<p>Inside the future there may be happening any side effects. It may open a file, print to console, connect to databases. We simply don't know. Let's
have a look how this problem would be solved using ZIO's effect system:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio._
<span class="hljs-keyword">import</span> zio.test.environment.<span class="hljs-type">TestConsole</span>

<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">Event</span>): <span class="hljs-type">ZIO</span>[<span class="hljs-type">TestConsole</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>] =
  <span class="hljs-keyword">for</span> {
    console &lt;- <span class="hljs-type">ZIO</span>.environment[<span class="hljs-type">TestConsole</span>].map(_.console)
    _       &lt;- console.putStrLn(<span class="hljs-string">s"Got <span class="hljs-subst">$event</span>"</span>)
  } <span class="hljs-keyword">yield</span> ()
</code></pre>
<p>With ZIO we've regained to ability to reason about the effects called. We know that <code>processEvent</code> can only call on <em>capabilities</em> of <code>TestConsole</code>,
so even though we still have <code>Unit</code> as the result, we have narrowed the possible effects space to a few.</p>
<blockquote>
<p><strong>Note:</strong> this is true assuming the programmer disciplines himself to only perform effects expressed in the type signature.
There is no way (at the moment) to enforce this by the compiler. There is some research done in this space, perhaps future programming languages
will enable us to further constrain side effects.</p>
</blockquote>
<p>However, the same method could be implemented as:</p>
<pre><code class="hljs css language-scala"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent2</span></span>(event: <span class="hljs-type">Event</span>): <span class="hljs-type">ZIO</span>[<span class="hljs-type">TestConsole</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>] =
  <span class="hljs-type">ZIO</span>.unit
</code></pre>
<p>How can we test it did exacly what we expected it to do?</p>
<h2><a class="anchor" aria-hidden="true" id="mocking"></a><a href="#mocking" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking</h2>
<p>In this sort of situations we need mock implementations of our collaborator service. As <em>Martin Fowler</em> puts it in his excellent article
<a href="https://martinfowler.com/articles/mocksArentStubs.html">Mocks Aren't Stubs</a>:</p>
<blockquote>
<p><strong>Mocks</strong> are (...) objects pre-programmed with expectations which form a specification of the calls they are expected to receive.</p>
</blockquote>
<p>ZIO Test provides a framework for mocking your modules.</p>
<h2><a class="anchor" aria-hidden="true" id="creating-a-mock-service"></a><a href="#creating-a-mock-service" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Creating a mock service</h2>
<p>Assuming you are following the <a href="/docs/howto/howto_use_module_pattern">module pattern</a>, for an <code>AccountListener</code> service we put the <em>capability tags</em> and the access
helpers (within <code>&gt;</code> object) in the service companion object:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio.test.mock._

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">AccountObserver</span> </span>{
  <span class="hljs-keyword">val</span> accountObserver: <span class="hljs-type">AccountObserver</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">Any</span>]
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">AccountObserver</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span>[<span class="hljs-type">R</span>] </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">AccountEvent</span>): <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>]
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">Service</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">processEvent</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">AccountEvent</span>, <span class="hljs-type">Unit</span>]</span>
  }

  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">&gt;</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Service</span>[<span class="hljs-type">AccountObserver</span>] </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">AccountEvent</span>) =
      <span class="hljs-type">ZIO</span>.accessM(_.accountObserver.processEvent(event))
  }
}
</code></pre>
<p>A <em>capability tag</em> is just a value which extends the <code>zio.test.mock.Method[A, B]</code> type constructor, where:</p>
<ul>
<li><code>A</code> is the type of methods input arguments</li>
<li><code>B</code> is the return type of method</li>
</ul>
<p>We model input arguments according to following scheme:</p>
<ul>
<li>for zero arguments the type is <code>Unit</code></li>
<li>for one or more arguments, regardless in how many parameter lists, the type is a <code>TupleN</code> where <code>N</code> is the size of arguments list</li>
</ul>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">ExampleService</span>[<span class="hljs-type">R</span>] </span>{
  <span class="hljs-keyword">val</span> static                                 : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">zeroArgs</span>                               </span>: <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Int</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">zeroArgsWithParens</span></span>()                   : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Long</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">singleArg</span></span>(arg1: <span class="hljs-type">Int</span>)                   : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multiArgs</span></span>(arg1: <span class="hljs-type">Int</span>, arg2: <span class="hljs-type">Long</span>)       : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">multiParamLists</span></span>(arg1: <span class="hljs-type">Int</span>)(arg2: <span class="hljs-type">Long</span>) : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">command</span></span>(arg1: <span class="hljs-type">Int</span>)                     : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">overloaded</span></span>(arg1: <span class="hljs-type">Int</span>)                  : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
  <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">overloaded</span></span>(arg1: <span class="hljs-type">Long</span>)                 : <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">String</span>]
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">ExampleService</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">static</span>             <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Unit</span>, <span class="hljs-type">String</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">zeroArgs</span>           <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Unit</span>, <span class="hljs-type">Int</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">zeroArgsWithParens</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Unit</span>, <span class="hljs-type">Long</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">singleArg</span>          <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">String</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">multiArgs</span>          <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">Long</span>), <span class="hljs-type">String</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">multiParamLists</span>    <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[(<span class="hljs-type">Int</span>, <span class="hljs-type">Long</span>), <span class="hljs-type">String</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">command</span>            <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">Unit</span>]</span>
  <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">overloaded</span> </span>{
    <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">_1</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Int</span>, <span class="hljs-type">String</span>]</span>
    <span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">_2</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Method</span>[<span class="hljs-type">Long</span>, <span class="hljs-type">String</span>]</span>
  }
}
</code></pre>
<blockquote>
<p><strong>Note:</strong> we're using tuples to represent multiple argument methods, which follows with a limit to max 22 arguments, as is Scala itself limited.</p>
</blockquote>
<p>For overloaded methods we simply nest a list of numbered objects, each representing subsequent overloads.</p>
<p>Next, we create the mockable implementation of the service:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">implicit</span> <span class="hljs-keyword">val</span> mockable: <span class="hljs-type">Mockable</span>[<span class="hljs-type">AccountObserver</span>] = (mock: <span class="hljs-type">Mock</span>) =&gt;
  <span class="hljs-keyword">new</span> <span class="hljs-type">AccountObserver</span> {
    <span class="hljs-keyword">val</span> accountObserver = <span class="hljs-keyword">new</span> <span class="hljs-type">AccountObserver</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">Any</span>] {
      <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">AccountEvent</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>] = mock(<span class="hljs-type">AccountObserver</span>.<span class="hljs-type">Service</span>.processEvent, event)
    }
  }
</code></pre>
<blockquote>
<p><strong>Note:</strong> To make our mockable implementation automatically discovered, we need to place it inside <code>AccountObserver</code> module's companion object.</p>
</blockquote>
<h2><a class="anchor" aria-hidden="true" id="scrapping-the-boilerplate"></a><a href="#scrapping-the-boilerplate" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Scrapping the boilerplate</h2>
<p>All of this machinery is repetitive and boring work, prone to simple mistakes. Using the <code>@accessible</code> and <code>@mockable</code> macros provided by
<a href="https://github.com/zio/zio-macros">zio-macros</a> we get the <em>capability tags</em>, <em>access helper</em> and <em>mockable implementation</em> autogenerated for us:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio.macros.access.accessible
<span class="hljs-keyword">import</span> zio.macros.mock.mockable
<span class="hljs-keyword">import</span> zio.console.<span class="hljs-type">Console</span>

<span class="hljs-meta">@accessible</span>
<span class="hljs-meta">@mockable</span>
<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">AccountObserver</span> </span>{
  <span class="hljs-keyword">val</span> accountObserver: <span class="hljs-type">AccountObserver</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">Any</span>]
}

<span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">AccountObserver</span> </span>{
  <span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">Service</span>[<span class="hljs-type">R</span>] </span>{
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">AccountEvent</span>): <span class="hljs-type">ZIO</span>[<span class="hljs-type">R</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>]
  }

  <span class="hljs-comment">// autogenerated `object Service { ... }`</span>
  <span class="hljs-comment">// autogenerated `object &gt; extends Service[AccountObserver] { ... }`</span>
  <span class="hljs-comment">// autogenerated `implicit val mockable: Mockable[AccountObserver] = ...`</span>
}

<span class="hljs-class"><span class="hljs-keyword">trait</span> <span class="hljs-title">AccountObserverLive</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AccountObserver</span> </span>{
  <span class="hljs-comment">// dependency on Console module</span>
  <span class="hljs-keyword">val</span> console: <span class="hljs-type">Console</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">Any</span>]

  <span class="hljs-keyword">val</span> accountObserver = <span class="hljs-keyword">new</span> <span class="hljs-type">AccountObserver</span>.<span class="hljs-type">Service</span>[<span class="hljs-type">Any</span>] {
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">processEvent</span></span>(event: <span class="hljs-type">AccountEvent</span>): <span class="hljs-type">UIO</span>[<span class="hljs-type">Unit</span>] =
      <span class="hljs-keyword">for</span> {
       _    &lt;- console.putStrLn(<span class="hljs-string">s"Got <span class="hljs-subst">$event</span>"</span>)
       line &lt;- console.getStrLn.orDie
       _    &lt;- console.putStrLn(<span class="hljs-string">s"You entered: <span class="hljs-subst">$line</span>"</span>)
      } <span class="hljs-keyword">yield</span> ()
  }
}
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="provided-zio-services"></a><a href="#provided-zio-services" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Provided ZIO services</h2>
<p>For each built-in ZIO service you will find their mockable counterparts in <code>zio.test.mock</code> package:</p>
<ul>
<li><code>MockClock</code> for <code>zio.clock.Clock</code></li>
<li><code>MockConsole</code> for <code>zio.console.Console</code></li>
<li><code>MockRandom</code> for <code>zio.random.Random</code></li>
<li><code>MockSystem</code> for <code>zio.system.System</code></li>
</ul>
<h2><a class="anchor" aria-hidden="true" id="setting-up-expectations"></a><a href="#setting-up-expectations" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Setting up expectations</h2>
<p>Finally we're all set and can create ad-hoc mock environments with our services.</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio.test._
<span class="hljs-keyword">import</span> zio.test.<span class="hljs-type">Assertion</span>._

<span class="hljs-keyword">val</span> event = <span class="hljs-keyword">new</span> <span class="hljs-type">AccountEvent</span> {}
<span class="hljs-keyword">val</span> app: <span class="hljs-type">ZIO</span>[<span class="hljs-type">AccountObserver</span>, <span class="hljs-type">Nothing</span>, <span class="hljs-type">Unit</span>] = <span class="hljs-type">AccountObserver</span>.&gt;.processEvent(event)
<span class="hljs-keyword">val</span> mockEnv: <span class="hljs-type">Managed</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">MockConsole</span>] = (
  <span class="hljs-type">MockSpec</span>.expectIn(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.putStrLn)(equalTo(<span class="hljs-string">s"Got <span class="hljs-subst">$event</span>"</span>)) *&gt;
  <span class="hljs-type">MockSpec</span>.expectOut(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.getStrLn)(<span class="hljs-string">"42"</span>) *&gt;
  <span class="hljs-type">MockSpec</span>.expectIn(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.putStrLn)(equalTo(<span class="hljs-string">"You entered: 42"</span>))
)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="providing-mocked-environment"></a><a href="#providing-mocked-environment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Providing mocked environment</h2>
<pre><code class="hljs css language-scala"><span class="hljs-class"><span class="hljs-keyword">object</span> <span class="hljs-title">AccountObserverSpec</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">DefaultRunnableSpec</span>(<span class="hljs-params">
  suite("processEvent"</span>)(<span class="hljs-params">
    testM("calls putStrLn &gt; getStrLn &gt; putStrLn and returns unit"</span>) </span>{
      <span class="hljs-keyword">val</span> result = app.provideManaged(mockEnv.map { mockConsole =&gt;
        <span class="hljs-keyword">new</span> <span class="hljs-type">AccountObserverLive</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Console</span> {
          <span class="hljs-keyword">val</span> console = mockConsole.console
        }
      })
      assertM(result, isUnit)
    }
  )
)
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="mocking-multiple-collaborators"></a><a href="#mocking-multiple-collaborators" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Mocking multiple collaborators</h2>
<p>In some cases we have more than one collaborating service being called. In such situations we need to build our expectations seperately for each
service and then combine them into single environment:</p>
<pre><code class="hljs css language-scala"><span class="hljs-keyword">import</span> zio.console.<span class="hljs-type">Console</span>
<span class="hljs-keyword">import</span> zio.random.<span class="hljs-type">Random</span>

<span class="hljs-keyword">val</span> mockConsole: <span class="hljs-type">Managed</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">MockConsole</span>] = (
  <span class="hljs-type">MockSpec</span>.expectIn(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.putStrLn)(equalTo(<span class="hljs-string">"What is your name?"</span>)) *&gt;
  <span class="hljs-type">MockSpec</span>.expectOut(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.getStrLn)(<span class="hljs-string">"Mike"</span>) *&gt;
  <span class="hljs-type">MockSpec</span>.expectIn(<span class="hljs-type">MockConsole</span>.<span class="hljs-type">Service</span>.putStrLn)(equalTo(<span class="hljs-string">"Mike, your lucky number today is 42!"</span>))
)

<span class="hljs-keyword">val</span> mockRandom: <span class="hljs-type">Managed</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">MockRandom</span>] =
  <span class="hljs-type">MockSpec</span>.expectOut(<span class="hljs-type">MockRandom</span>.<span class="hljs-type">Service</span>.nextInt._1)(<span class="hljs-number">42</span>)

<span class="hljs-keyword">val</span> combinedEnv: <span class="hljs-type">Managed</span>[<span class="hljs-type">Nothing</span>, <span class="hljs-type">Console</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Random</span>] =
  (mockConsole &amp;&amp;&amp; mockRandom)
    .map {
      <span class="hljs-keyword">case</span> (c, r) =&gt; <span class="hljs-keyword">new</span> <span class="hljs-type">Console</span> <span class="hljs-keyword">with</span> <span class="hljs-type">Random</span> {
       <span class="hljs-keyword">val</span> console = c.console
       <span class="hljs-keyword">val</span> random = r.random
      }
    }

<span class="hljs-keyword">val</span> combinedApp =
  <span class="hljs-keyword">for</span> {
    _    &lt;- console.putStrLn(<span class="hljs-string">"What is your name?"</span>)
    name &lt;- console.getStrLn.orDie
    num  &lt;- random.nextInt
    _    &lt;- console.putStrLn(<span class="hljs-string">s"<span class="hljs-subst">$name</span>, your lucky number today is <span class="hljs-subst">$num</span>!"</span>)
  } <span class="hljs-keyword">yield</span> ()

<span class="hljs-keyword">val</span> result = combinedApp.provideManaged(combinedEnv)
assertM(result, isUnit)
</code></pre>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/howto/howto_test_effects"><span class="arrow-prev">← </span><span>Test effects</span></a><a class="docs-next button" href="/docs/howto/howto_handle_errors"><span>Handle errors</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#how-to-test-interactions-between-services">How to test interactions between services?</a></li><li><a href="#hidden-outputs">Hidden outputs</a></li><li><a href="#mocking">Mocking</a></li><li><a href="#creating-a-mock-service">Creating a mock service</a></li><li><a href="#scrapping-the-boilerplate">Scrapping the boilerplate</a></li><li><a href="#provided-zio-services">Provided ZIO services</a></li><li><a href="#setting-up-expectations">Setting up expectations</a></li><li><a href="#providing-mocked-environment">Providing mocked environment</a></li><li><a href="#mocking-multiple-collaborators">Mocking multiple collaborators</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/navbar_brand.png" alt="ZIO"/></a><div><h5>GitHub</h5><a class="github-button" href="https://github.com/zio/zio" data-icon="octicon-star" data-count-href="/zio/zio/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a></div><div><h5>Chat with us on Discord</h5><a href="https://discord.gg/2ccFBr4"><img src="/img/discord.png" width="120" alt="discord"/></a></div><div><h5>Additional resources</h5><a href="https://javadoc.io/doc/dev.zio/zio_2.12/">Scaladoc of zio</a></div></section><section class="copyright">Copyright © 2019 ZIO Maintainers</section></footer></div></body></html>